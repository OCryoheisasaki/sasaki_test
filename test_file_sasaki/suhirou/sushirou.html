<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ã‚·ãƒ­ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body>
<div id="app">
    <customer_confirmation_screen></customer_confirmation_screen>
</div>

<script>
    // å‘¼ã³å‡ºã—ä¸­ãƒªã‚¹ãƒˆ
    Vue.component('called_list', {
        props: ['called_numbers'],
        template: `
          <div>
            <table>
              <tr>
                <th colspan="5">å‘¼ã³å‡ºã—ä¸­ã®ç•ªå·</th>
              </tr>
              <tr v-if="called_numbers.length > 0">
                <td v-for="called in called_numbers" :key="called.number">
                  {{ called.number }}<br>
                  <span style="font-size:0.8em;">{{ getElapsedSec(called.called_time) }}ç§’çµŒé</span>
                </td>
              </tr>
            </table>
            <p v-if="called_numbers.length === 0">ç¾åœ¨å‘¼ã³å‡ºã—ä¸­ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</p>
          </div>
        `,
        data() {
            return {
                now: Date.now(),
                timer: null
            };
        },
        mounted() {
            var self = this;
            this.timer = setInterval(function() {
                self.now = Date.now();
            }, 1000);
        },
        beforeDestroy() {
            clearInterval(this.timer);
        },
        methods: {
            getElapsedSec: function(called_time) {
                return Math.max(0, Math.floor((this.now - called_time) / 1000));
            }
        }
    });

    // å¾…æ©Ÿãƒªã‚¹ãƒˆ
    Vue.component('waiting_list', {
        props: ['waiting_customers'],
        template: `
          <div>
            <h3>å¾…æ©Ÿä¸­ã®ãŠå®¢æ§˜</h3>
            <p v-if="waiting_customers.length === 0">ç¾åœ¨å¾…æ©Ÿä¸­ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</p>
            <table v-else>
              <tr>
                <td v-for="customer in waiting_customers" :key="customer.number">
                  {{ customer.number }}
                </td>
              </tr>
            </table>
            <h1>ç¾åœ¨ã®å¾…æ©Ÿçµ„æ•°<b>{{ waiting_customers.length }}</b>çµ„</h1>
          </div>
        `
    });

    // ç™ºåˆ¸æ©Ÿ
    Vue.component('ticketing_function', {
        template: `
          <div>
            <h3>ç™ºåˆ¸æ©Ÿ</h3>
            <h1>æ¬¡ã®ç•ªå·ã¯<b>{{ getNextNumber() }}</b></h1>
            <button @click="addCustomer">æ•´ç†åˆ¸ç™ºè¡Œ</button>
          </div>
        `,
        data() {
            return {
                next_waiting_number: 0
            };
        },
        methods: {
            addCustomer() {
                this.next_waiting_number++;
                const new_customer = {number: this.next_waiting_number};
                this.$emit('add-new-customer', new_customer);
            },
            getNextNumber() {
                return this.next_waiting_number + 1;
            }
        }
    });

    // ã‚¹ã‚¿ãƒƒãƒ•æ“ä½œç”»é¢ï¼ˆå¾…æ©Ÿä¸­ + å‘¼ã³å‡ºã—ä¸€è¦§ï¼‰
    Vue.component('waiting_customer_call_list', {
        props: ['waiting_customers', 'called_numbers'],
        template: `
          <div>
            <h3>ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢</h3>
            <table v-if="waiting_customers.length > 0">
              <tr>
                <th>é¸æŠ</th>
                <th>ç•ªå·</th>
                <th>æ“ä½œ</th>
              </tr>
              <tr v-for="customer in waiting_customers" :key="customer.number">
                <td>
                  <input type="checkbox"
                         :value="customer.number"
                         v-model="selected_numbers">
                </td>
                <td>{{ customer.number }}</td>
                <td>
                  <button @click="$emit('call-customer', customer.number)">å‘¼ã³å‡ºã—</button>
                  <button @click="$emit('remove-customer', customer.number)">å‰Šé™¤</button>
                </td>
              </tr>
            </table>
            <p v-else>ç¾åœ¨å¾…æ©Ÿä¸­ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</p>
            <button @click="callSelected" :disabled="selected_numbers.length === 0">ã¾ã¨ã‚ã¦å‘¼ã³å‡ºã—</button>
            <called_list :called_numbers="called_numbers" @return-to-waiting="returnToWaiting"></called_list>
          </div>
        `,
        data() {
            return {
                selected_numbers: []
            };
        },
        methods: {
            callSelected() {
                this.selected_numbers.forEach(number => {
                    this.$emit('call-customer', number);
                });
                this.selected_numbers = [];
            },
            returnToWaiting(number) {
                this.$emit('return-to-waiting', number);
            }
        }
    });


    Vue.component('customer_entry_exit_screen', {
        props: ['waiting_customers', 'called_numbers'],
        template: `
          <div>
            <h2>ãŠå®¢æ§˜ç”¨ å…¥é€€å®¤ç”»é¢</h2>
            <table border="3" style="margin: auto; border-collapse: collapse;">
              <tr>
                <th>ç•ªå·</th>
                <th>çŠ¶æ…‹ / æ“ä½œ</th>
              </tr>
              <tr v-for="customer in getDisplayCustomers()" :key="customer.number">
                <td style="padding: 8px; text-align: center;">{{ customer.number }}</td>
                <td style="padding: 8px; text-align: center;">
                  <div v-if="customer.called">
                    <button @click="enter(customer.number)">å…¥å®¤</button>
                    <button @click="exit(customer.number)">é€€å®¤</button>
                  </div>
                  <div v-else>å¾…æ©Ÿä¸­</div>
                </td>
              </tr>
            </table>

            <h3>å…¥å®¤ä¸­ã®ãŠå®¢æ§˜</h3>
            <table border="1" style="margin: auto; border-collapse: collapse;" v-if="entered_customers.length > 0">
              <tr>
                <th>ç•ªå·</th>
              </tr>
              <tr v-for="number in entered_customers" :key="number">
                <td style="padding: 8px; text-align: center;">{{ number }}</td>
              </tr>
            </table>
            <p v-else>å…¥å®¤ä¸­ã®æ–¹ã¯ã„ã¾ã›ã‚“</p>
          </div>
        `,
        data() {
            return {
                entered_customers: []
            };
        },
        methods: {
            enter(customer_number) {
                if (!this.entered_customers.includes(customer_number)) {
                    this.entered_customers.push(customer_number);
                    this.$emit('entered', customer_number);

                    let called_number = -1;
                    for (let i = 0; i < this.called_numbers.length; i++) {
                        if (this.called_numbers[i] === customer_number) {
                            called_number = i;
                            break;
                        }
                    }
                    if (called_number !== -1) {
                        this.called_numbers.splice(called_number, 1);
                    }
                }
            },
            exit(customer_number) {
                let entered_index = -1;
                for (let i = 0; i < this.entered_customers.length; i++) {
                    if (this.entered_customers[i] === customer_number) {
                        entered_index = i;
                        break;
                    }
                }
                if (entered_index !== -1) {
                    this.entered_customers.splice(entered_index, 1);
                }

                let called_index = -1;
                for (let i = 0; i < this.called_numbers.length; i++) {
                    if (this.called_numbers[i] === customer_number) {
                        called_index = i;
                        break;
                    }
                }
                if (called_index !== -1) {
                    this.called_numbers.splice(called_index, 1);
                }
            },
            getDisplayCustomers() {
                const display = [];

                for (let i = 0; i < this.called_numbers.length; i++) {
                    display.push({ number: this.called_numbers[i].number, called: true });
                }

                for (let i = 0; i < this.waiting_customers.length; i++) {
                    const customer_number = this.waiting_customers[i].number;
                    let exists = false;
                    for (let index = 0; index < this.called_numbers.length; index++) {
                        if (this.called_numbers[index].number === customer_number) {
                            exists = true;
                            break;
                        }
                    }
                    if (!exists) {
                        display.push({ number: customer_number, called: false });
                    }
                }

                return display;
            }
        }
    });


    // ãƒ¡ã‚¤ãƒ³ç”»é¢
    Vue.component('customer_confirmation_screen', {
        template: `
          <div>
            <h1>ğŸ£ å‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼ ğŸ£</h1>

            <div style="display:flex; justify-content:space-around; margin-bottom:20px;">
              <called_list :called_numbers="called_numbers"></called_list>
              <waiting_list :waiting_customers="waiting_customers"></waiting_list>
            </div>

            <div style="margin-bottom:20px; text-align:center;">
              <ticketing_function @add-new-customer="addToWaitingList"></ticketing_function>
            </div>

            <div style="margin-top:20px; text-align:center;">
              <waiting_customer_call_list
                  :waiting_customers="waiting_customers"
                  :called_numbers="called_numbers"
                  @call-customer="handleCallCustomer"
                  @return-to-waiting="handleReturnToWaiting"
                  @remove-customer="handleRemoveCustomer"
              ></waiting_customer_call_list>
            </div>

            <div style="margin-top:30px; text-align:center;">
              <customer_entry_exit_screen
                  :waiting_customers="waiting_customers"
                  :called_numbers="called_numbers"
              ></customer_entry_exit_screen>
            </div>
          </div>
        `,
        data() {
            return {
                waiting_customers: [],
                called_numbers: [],
                timer_id: null
            };
        },
        mounted() {
            this.timer_id = setInterval(this.checkCalledTimeout, 1000);
        },
        methods: {
            checkCalledTimeout() {
                const now = Date.now();
                const called_list = this.called_numbers.slice();
                for (const called of called_list) {
                    const elapsed_second = now - called.called_time;
                    if (elapsed_second >= 60000) {
                        this.handleReturnToWaiting(called.number);
                    }
                }
            },
            addToWaitingList(new_customer) {
                this.waiting_customers.push(new_customer);
            },
            handleCallCustomer(customer_number) {
                this.called_numbers.push({
                    number: customer_number,
                    called_time: Date.now()
                });
                for (let i = 0; i < this.waiting_customers.length; i++) {
                    if (this.waiting_customers[i].number === customer_number) {
                        this.waiting_customers.splice(i, 1);
                        break;
                    }
                }
            },
            handleReturnToWaiting(customer_number) {
                let index_number = -1;
                for (let i = 0; i < this.called_numbers.length; i++) {
                    if (this.called_numbers[i].number === customer_number) {
                        index_number = i;
                        break;
                    }
                }
                if (index_number !== -1) {
                    this.called_numbers.splice(index_number, 1);
                }

                let exists = false;
                for (let i = 0; i < this.waiting_customers.length; i++) {
                    if (this.waiting_customers[i].number === customer_number) {
                        exists = true;
                        break;
                    }
                }
                if (!exists) {
                    this.waiting_customers.push({ number: customer_number });
                }
            },
            getDisplayCustomers() {
                const display = [];

                for (let i = 0; i < this.called_numbers.length; i++) {
                    display.push({ number: this.called_numbers[i].number, called: true });
                }

                for (let i = 0; i < this.waiting_customers.length; i++) {
                    const customer_number = this.waiting_customers[i].number;
                    let exists = false;
                    for (let index = 0; index < this.called_numbers.length; index++) {
                        if (this.called_numbers[index].number === customer_number) {
                            exists = true;
                            break;
                        }
                    }
                    if (!exists) {
                        display.push({ number: customer_number, called: false });
                    }
                }
                return display;
            }

        }
    });

    new Vue({
        el: '#app'
    });

</script>
</body>
</html>

<style>
    body {
        font-family: sans-serif;
        text-align: center;
        margin: 20px;
        color: #000;
        background-color: #fff;
    }

    table {
        margin: 0 auto 20px auto;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #000;
        padding: 5px 10px;
        font-size: 1.2em;
    }

    button {
        padding: 5px 10px;
        margin: 2px;
    }
</style>
